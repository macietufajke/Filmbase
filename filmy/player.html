<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Odtwarzacz</title>
    <link rel="stylesheet" href="styl.css">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        body {
            margin: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .player-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .video-wrapper {
            flex: 1;
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .source-panel {
            background: #111;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            border-top: 1px solid #333;
            flex-wrap: wrap;
        }

        .source-btn {
            padding: 10px 20px;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .source-btn.active,
        .source-btn:hover {
            background: var(--primary-accent, #00b3ff);
            border-color: #fff;
        }
    </style>
</head>

<body>

    <div id="player-container" class="player-container">
        <div class="video-wrapper" id="video-wrapper">
            <!-- Player/Iframe injected here -->
        </div>

        <button class="source-btn active" onclick="loadSource('lulu', this)">LuluStream</button>
        <button class="source-btn" onclick="loadSource('s1', this)">VidSrc (Backup)</button>
    </div>
    <div id="manual-input-container" style="display:none; margin-top: 10px; text-align: center;">
        <input type="text" id="lulu-id-input" placeholder="Wpisz ID pliku LuluStream (np. xyz123)"
            style="padding: 8px; border-radius: 4px; border: 1px solid #444; background: #222; color: white;">
        <button onclick="playManualLulu()"
            style="padding: 8px 16px; background: #00b3ff; border: none; color: white; border-radius: 4px; cursor: pointer;">Odtw√≥rz</button>
    </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');
        const movieTitle = urlParams.get('title') || "Film";
        const sourceParam = urlParams.get('source'); // 'lulu', 's1'
        const videoWrapper = document.getElementById('video-wrapper');

        if (!movieId && !movieTitle) {
            alert("Brak ID fiilmu lub tytu≈Çu!");
            // window.close(); // Optional
        }

        // --- CONFIGURATION ---
        const PL_PARAMS = "?lang=pl&ds_lang=pl&autoplay=1";

        function loadSource(key, btn) {
            // Update active state
            if (btn) {
                document.querySelectorAll('.source-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            const iframeAttrs = 'width="100%" height="100%" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen';
            const manualInput = document.getElementById('manual-input-container');
            const encodedTitle = encodeURIComponent(movieTitle);

            if (key === 'lulu') {
                // LuluStream - Client-side search (No PHP required)
                videoWrapper.innerHTML = `<div style="color:white;text-align:center;margin-top:20%;"><h3>üîç Szukam filmu na serwerze LuluStream...</h3></div>`;
                manualInput.style.display = 'none';
                resolveLulu(movieTitle, movieId); // Pass Title and BackupID
            } else if (key === 's1') {
                // VidSrc (Backup)
                videoWrapper.innerHTML = `<iframe src="https://vidsrc.me/embed/movie/${movieId}?lang=pl" ${iframeAttrs}></iframe>`;
                manualInput.style.display = 'none';
            }
        }

        async function resolveLulu(title, backupId) {
            const apiKey = "2377408fo21vaoc12jp7p";
            const searchUrl = `https://lulustream.com/api/file/list?key=${apiKey}&title=${encodeURIComponent(title)}`;
            const iframeAttrs = 'width="100%" height="100%" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen';

            try {
                const response = await fetch(searchUrl);
                const data = await response.json();

                if (data.status === 200 && data.result && data.result.files && data.result.files.length > 0) {
                    const files = data.result.files;
                    let bestMatch = null;
                    let highestScore = -1;

                    files.forEach(file => {
                        const name = file.title.toLowerCase();
                        let score = 0;
                        if (name.includes('pl')) score += 10;
                        if (name.includes('lektor')) score += 5;
                        if (name.includes('dubbing')) score += 5;
                        if (name.includes('napisy')) score += 3;
                        if (file.canplay == 1) score += 2;

                        if (score > highestScore) {
                            highestScore = score;
                            bestMatch = file.file_code;
                        }
                    });

                    if (!bestMatch) bestMatch = files[0].file_code;

                    // Success - Load Lulu
                    videoWrapper.innerHTML = `<iframe src="https://lulustream.com/e/${bestMatch}" ${iframeAttrs}></iframe>`;

                } else {
                    throw new Error("Nie znaleziono plik√≥w.");
                }
            } catch (error) {
                console.error("Lulu Error:", error);
                // Fallback to VidSrc
                videoWrapper.innerHTML = `<iframe src="https://vidsrc.me/embed/movie/${backupId}?lang=pl" ${iframeAttrs}></iframe>`;

                // Optional: Show toast/notice that we switched to backup
                const notice = document.createElement('div');
                notice.innerHTML = "Nie znaleziono na LuluStream. Prze≈ÇƒÖczono na serwer zapasowy.";
                notice.style.cssText = "position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(200,0,0,0.8);color:white;padding:5px 10px;border-radius:5px;pointer-events:none;z-index:999;";
                videoWrapper.appendChild(notice);
                setTimeout(() => notice.remove(), 4000);
            }
        }

        // Default logic
        if (sourceParam === 's1') {
            loadSource('s1', document.querySelector("button[onclick*='s1']"));
        } else {
            // Default to Lulu
            loadSource('lulu', document.querySelector("button[onclick*='lulu']"));
        }

    </script>
</body>

</html>